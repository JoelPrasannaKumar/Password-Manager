<!-- views/login.ejs -->
<%- include('partials/header') %>

<div class="form-card">
    <h2>Log In</h2>
    <p id="error-message" class="error-message"></p>
    <form id="login-form">
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
        </div>
        <button type="submit" class="btn btn-primary">Log In</button>
    </form>
</div>

<!-- Firebase configuration and client SDK script -->
<script id="firebase-config" type="application/json">
    <%- JSON.stringify(firebaseClientConfig) %>
</script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script>
    // This script is for client-side login and passing the ID token to the server
    document.addEventListener('DOMContentLoaded', () => {
        const loginForm = document.getElementById('login-form');
        const errorMessageEl = document.getElementById('error-message');

        const firebaseConfig = JSON.parse(document.getElementById('firebase-config').textContent);
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(app);

        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const idToken = await userCredential.user.getIdToken();

                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idToken })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    window.location.href = result.redirect;
                } else {
                    errorMessageEl.textContent = result.error || 'Login failed.';
                }
            } catch (error) {
                errorMessageEl.textContent = 'Invalid email or password.';
                console.error('Firebase login error:', error);
            }
        });
    });
</script>

<%- include('partials/footer') %>
